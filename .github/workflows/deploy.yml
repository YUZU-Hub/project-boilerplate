name: Build and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: app-test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start container
        run: |
          docker run -d \
            --name app-test \
            -p 3000:3000 \
            -p 3001:3001 \
            -p 3002:3002 \
            -p 8090:8090 \
            app-test:latest

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 10

          MAX_RETRIES=30
          RETRY_COUNT=0

          until curl -sf http://localhost:3000/health && curl -sf http://localhost:8090/api/health; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
              echo "Services failed to start"
              docker logs app-test
              exit 1
            fi
            echo "Attempt $RETRY_COUNT/$MAX_RETRIES - waiting..."
            sleep 2
          done

          echo "All services are ready!"

      - name: Test Homepage health endpoint
        run: |
          response=$(curl -sf http://localhost:3000/health)
          echo "Homepage health: $response"
          echo "$response" | grep -q '"status":"ok"' || exit 1

      - name: Test Webapp health endpoint
        run: |
          response=$(curl -sf http://localhost:3001/health)
          echo "Webapp health: $response"
          echo "$response" | grep -q '"status":"ok"' || exit 1

      - name: Test Admin health endpoint
        run: |
          response=$(curl -sf http://localhost:3002/health)
          echo "Admin health: $response"
          echo "$response" | grep -q '"status":"ok"' || exit 1

      - name: Test PocketBase health endpoint
        run: |
          response=$(curl -sf http://localhost:8090/api/health)
          echo "PocketBase health: $response"

      - name: Test Homepage serves content
        run: |
          response=$(curl -sf http://localhost:3000/)
          echo "$response" | grep -q "Project Name" || exit 1
          echo "Homepage serves content correctly"

      - name: Test Webapp serves content
        run: |
          response=$(curl -sf http://localhost:3001/)
          echo "$response" | grep -q "Welcome" || exit 1
          echo "Webapp serves content correctly"

      - name: Show container logs on failure
        if: failure()
        run: docker logs app-test

      - name: Stop container
        if: always()
        run: docker stop app-test || true

      - name: Deployment notification
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Build and tests passed!"
          echo "Coolify will automatically deploy changes from the main branch."
          echo "Monitor your Coolify dashboard for deployment status."
