# Development Dockerfile
# Supports volume mounts for hot-reload

FROM node:20-alpine

ARG POCKETBASE_VERSION=0.25.0
ARG TARGETARCH

# Install wget for health checks and downloading PocketBase
RUN apk add --no-cache wget unzip

# Download PocketBase
RUN wget -q "https://github.com/pocketbase/pocketbase/releases/download/v${POCKETBASE_VERSION}/pocketbase_${POCKETBASE_VERSION}_linux_${TARGETARCH}.zip" -O /tmp/pocketbase.zip \
    && unzip /tmp/pocketbase.zip -d /pb \
    && chmod +x /pb/pocketbase \
    && rm /tmp/pocketbase.zip

# Create directories
RUN mkdir -p /app/homepage /app/webapp /app/admin /app/server /pb/pb_data /pb/pb_hooks /pb/pb_migrations

WORKDIR /app/server

# Copy package files and install dependencies
# This layer is cached and only rebuilds when package.json changes
COPY server/package*.json ./
RUN npm install

# Copy entrypoint (this won't change often)
COPY entrypoint.dev.sh /entrypoint.dev.sh
RUN chmod +x /entrypoint.dev.sh

# Environment defaults
ENV NODE_ENV=development
ENV HOMEPAGE_PORT=3000
ENV WEBAPP_PORT=3001
ENV ADMIN_PORT=3002
ENV API_URL=http://localhost:8090

# Expose ports
EXPOSE 3000 3001 3002 8090

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=15s --retries=3 \
    CMD wget -q --spider http://localhost:3000/health && \
        wget -q --spider http://localhost:8090/api/health || exit 1

# Run with dev entrypoint
ENTRYPOINT ["/entrypoint.dev.sh"]
